# CSE 546 Project Report

Authors:
- Satya Pranay Manas Nunna
- Vraj Rana 
- Nishant Chaturvedi

## Problem Statement

This project aims to develop an elastic web application that can automatically scale in and out based on demand in a cost-effective manner using Amazon Web Services (AWS). The application offers image recognition as a service and scales the number of server instances dynamically according to the number of incoming requests. The architectural details are explained in the following sections.

## Design and Implementation

### 2.1 Architecture

**Architecture Description:**

Our architecture consists of the following key components:
- **Web Tier (EC2 instance)**: This tier accepts user requests and sends them to the application tier. It also stores the user-requested images in an S3 bucket for persistence.
- **SQS Request Queue (SqsInputCloud)**: All incoming user requests are added to this queue for the application tier to process.
- **Application Tier (EC2 instances)**: The App Tier consists of multiple instances (1 minimum, 19 maximum) that listen to the SqsInputCloud queue and process user-requested images. It also stores the classification results in the S3 bucket (S3OutputCloud) for persistence.
- **SQS Response Queue (SqsOutputCloud)**: This queue stores the generated output responses for user requests.
- **CloudWatch**: Used to monitor the SqsInputCloud queue and generate alerts. These alerts trigger an EC2 Auto Scaling group to increase or decrease the number of instances based on demand.

**AWS Services Used:**
- **AWS EC2**: Instances run the web tier and app tier. The instances were created based on a Linux image provided by the professor, which included the deep learning model and environment pre-installed for implementing the Node.js code related to the application.
- **AWS SQS**: SqsInputCloud maintains the request queue, while SqsOutputCloud stores the output responses generated by the app tier. SQS is used to decouple the web tier and app tier.
- **AWS S3**: S3InputCloud is used to store user-uploaded images before processing, and S3OutputCloud is used to store the classification results along with image file names.
- **CloudWatch**: Monitors the SqsInputCloud queue to generate alerts that trigger the AWS Auto Scaling group for dynamic instance scaling.

### 2.2 Autoscaling

Auto-scaling in this project is implemented using CloudWatch. The procedure is as follows:

1. The input queue (SqsInputCloud) is monitored to check the number of available messages. If the number exceeds 5 for more than a minute, CloudWatch generates an alert.
2. The alert triggers the AWS EC2 Auto Scaling group, which creates the appropriate number of instances to handle the increased workload.
3. Another alert checks the number of requests in the queue every minute. If the number of requests falls below 5, an alert is generated, and the Auto Scaling group terminates instances until there is only one instance left.

## 3. Testing and Evaluation

To test the scalability of the application, a workload generator was used to generate 100 requests to the server. The following results were observed:

### 3.1 Query
```shell
python3 multithread_workload_generator.py --num_request 100 --url http://100.25.10.233:3000/ --image_folder imagenet-100/
```

**Output of the Query:**


### 3.2 State of the Instances

As the number of messages increased in the SqsInputCloud queue, the alarm to scale up the instances was triggered. The figure below shows how the number of instances increased after the requests were received. Once the messages in the queue reduced, the instances began decreasing gradually.



### 3.3 S3 Bucket (s3inputcloud)

All 100 images were stored in the S3 bucket (s3inputcloud) for the classifier to process. The figure below shows the state of the bucket after the requests were processed.



### 3.4 S3 Bucket (s3outputcloud)

The classification results for the 100 input images were stored in the S3 output bucket (s3outputcloud). The figure below shows the state of the bucket after processing the requests.



## 4. Code and Installation

### App Tier

The App Tier is the main server responsible for classifying the results of the input images. It is connected to the AWS Auto Scaling group to increase or decrease the number of instances based on demand.

**Code:**
- **Classifier**: This folder contains the image classifier and imagenet-labels.json files. The image classifier is executed from the `app_tier.sh` file after receiving the input from the SqsInputCloud queue and storing the input in the S3 input bucket.
- **Controller**: This folder contains `receiver_app_tier.js` and `sender_app_tier.js` files.
  - `receiver_app_tier.js`: This file fetches data from the SqsInputCloud queue and stores it in the S3 input bucket.
  - `sender_app_tier.js`: This file runs after the image classifier. It stores the output in the S3 output bucket, from which the SqsOutputCloud queue retrieves the output for the REST API.
- `app_tier_installation.sh`: This script contains commands to download all the modules required to run the App Tier.
- `app_tier.sh`: This file executes `receiver_app_tier.js`, the image classifier, and `sender_app_tier.js` in order in every instance using crontab to generate the output.

**Installation:**
1. Run the script `app_tier_installation.sh` to update all the dependencies.
2. Navigate to the `/app_tier/` directory and run the command `npm install` to update all the Node.js modules.
3. Create a cron job using `crontab -e` and add the following cron schedule:
   ```shell
   * * * * * sh /home/ubuntu/app_tier/app_tier.sh
   * * * * * sleep 10; sh /home/ubuntu/app_tier/app_tier.sh
   * * * * * sleep 20; sh /home/ubuntu/app_tier/app_tier.sh
   * * * * * sleep 30; sh /home/ubuntu/app_tier/app_tier.sh
   * * * * * sleep 40; sh /home/ubuntu/app_tier/app_tier.sh
   * * * * * sleep 50; sh /home/ubuntu/app_tier/app_tier.sh
   ```

### Web Tier

The Web Tier is the main web interface for users to interact. It exposes the API to upload images and responds with the classification results.

**Code:**
- **app.js**: The main server file that exposes the Express server on port 3000. It exposes one REST endpoint for uploading images and sends the classification results as the response.
- **aws-helper/s3helper.js**: Provides S3 helper methods to upload the input image to the S3 bucket (`s3